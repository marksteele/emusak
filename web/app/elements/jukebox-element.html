<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/iron-label/iron-label.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/poly-filter/poly-filter.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">

<!-- jukebox elements -->
<link rel="import" href="jukebox-control-element.html">

<dom-module id="jukebox-element">
  <template>
    <style>

      .item {
        @apply(--layout-horizontal);
        cursor: pointer;
        padding: 16px 22px;
        border-bottom: 1px solid #DDD;
      }
    .item:focus,
      .item.selected:focus {
        outline: 0;
        background-color: #ddd;
      }
 .item.selected {
        background-color: var(--google-grey-300);
        border-bottom: 1px solid #ccc;
      }
      iron-list {
       height: 400px;
      }
    </style>
    <div>
      <audio src="" id="player"></audio>
      <iron-ajax
         id="ajax"
         url="/playlist"
         last-response="{{playlist}}"
         handle-as="json"
         on-response="initTrack"
         auto>
      </iron-ajax>
      <poly-filter
         array-to-filter="[[playlist]]"
         filter="[[filterString]]"
         filtered-array="{{filteredPlaylist}}">
      </poly-filter>
      <jukebox-control-element id="control">

      </jukebox-control-element>
      <paper-material elevation="1">
        <div class="item">
          <iron-label>Search <input is="iron-input" type="string" value="{{filterString::input}}" autofocus></iron-label>
        </div>
        <iron-list
           items="[[filteredPlaylist]]"
           as="song"
           id="playlist"
           selection-enabled>
          <template>
            <div
               tabindex$="[[tabIndex]]"
               index$="[[index]]"
               selected$="[[selected]]"
               artist="[[song.artist]]"
               title="[[song.title]]"
               url="[[song.url]]"
               class$="[[_computedClass(selected)]]"
               on-tap="_itemSelected">[[song.artist]] - [[song.title]]</div>
          </template>
        </iron-list>
      </paper-material>
    </div>
  </template>
  <script>
    (function(win, doc, undefined){
      Polymer({
        is: 'jukebox-element',
        properties: {
          last: Object,
          currentTrack: Number,
          paused: Boolean,
          playing: Boolean
        },
        ready: function() {
          var that = this,
          control = this.$.control,
          player = this.$.player,
          playlist = this.$.playlist;
          player.addEventListener('ended',function(e){
            if (this.currentTrack === undefined) {
              if (playlist.items != null) {
                nextTrack = 0;
              } else {
                alert('empty playlist');
              }
            } else {
              if (this.currentTrack == (playlist.items.length -1)) {
                nextTrack = 0;
              } else {
                nextTrack = this.currentTrack + 1;
              }
            }
            this.currentTrack = nextTrack;
            player.src = playlist.items[nextTrack].url;
            control.song = playlist.items[nextTrack];
            playlist.selectItem(nextTrack);
            playlist.scrollToIndex(nextTrack);
            player.load();
            player.play();
          });
          control.addEventListener('play',function (e) {
            if (this.currentTrack === undefined) {
              if (playlist.items != null) {
                this.currentTrack = 0;
                song = playlist.items[0];
                player.src = song.url;
                player.load();
                player.play();
                this.playing = true;
                playlist.selectItem(0);
                control.song = song;
              } else {
                alert('No tracks available');
              }
            } else {
              player.src = playlist.items[this.currentTrack].url;
              player.load();
              player.play();
              this.playing = true;
            }
          });
          control.addEventListener('pause',function (e) {
            if (this.currentTrack === undefined || this.playing == false) {
              alert('Not playing!');
            } else {
              if (this.paused == true) {
                player.play();
                this.paused = false;
              } else {
                player.pause();
                this.paused = true;
              }
            }
          });
          control.addEventListener('stop',function (e) {
            if (this.currentTrack === undefined || this.playing == false) {
              alert('Not playing!');
            } else {
              this.playing = false;
              player.pause();
              player.currentTime = 0;
            }
          });
          control.addEventListener('next',function (e) {
            if (this.currentTrack === undefined) {
              if (playlist.items != null) {
                nextTrack = 0;
              } else {
                alert('empty playlist');
              }
            } else {
              if (this.currentTrack == (playlist.items.length -1)) {
                nextTrack = 0;
              } else {
                nextTrack = this.currentTrack + 1;
              }
            }
            this.currentTrack = nextTrack;
            player.src = playlist.items[nextTrack].url;
            control.song = playlist.items[nextTrack];
            playlist.selectItem(nextTrack);
            playlist.scrollToIndex(nextTrack);
            if (this.playing == true) {
              player.load();
              player.play();
            }
          });
          control.addEventListener('prev',function (e) {
            if (this.currentTrack === undefined) {
              if (playlist.items != null) {
                nextTrack = 0;
              } else {
                alert('empty playlist');
              }
            } else {
              if (this.currentTrack == 0) {
                nextTrack = playlist.items.length - 1;
              } else {
                nextTrack = this.currentTrack - 1;
              }
            }
            this.currentTrack = nextTrack;
            player.src = playlist.items[nextTrack].url;
            control.song = playlist.items[nextTrack];
            playlist.selectItem(nextTrack);
            playlist.scrollToIndex(nextTrack);
            if (this.playing == true) {
              player.load();
              player.play();
            }
          });
        },
        initTrack: function() {
          console.log('data loaded');
        },
        _itemSelected: function(e) {
          this.playing = true;
          var song = e.model.song
          control.song = song;
          this.currentTrack = e.model.index + 1;
          player.src = song.url;
          player.load();
          player.play();
        },
     _computedClass: function(isSelected) {
          var classes = 'item';
          if (isSelected) {
            classes += ' selected';
          }
          return classes;
        },

      })
    })(window, document);
  </script>
</dom-module>
